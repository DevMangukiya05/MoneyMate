<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retailer Purchase & Dues Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #007bff; color: white; }
    button { padding: 8px 12px; margin: 5px; border: none; background-color: #007bff; color: white; cursor: pointer; border-radius: 4px; }
    button:hover { background-color: #0056b3; }
    .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 6px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-header { font-size: 18px; margin-bottom: 10px; }
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    .actions button { margin-right: 5px; }
    #retailerDetails { display: none; background: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #purchaseTable th { background-color: #28a745; }
    .total-dues { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #d9534f; }
    .paid { color: green; }
    .unpaid { color: red; }
  </style>
</head>
<body>

  <h1>Retailer Purchase & Dues Tracker</h1>
  <button id="addRetailerBtn">Add New Retailer</button>

  <table id="retailerTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Total Due</th>
        <th>Last Payment Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Add Retailer Modal -->
  <div id="addRetailerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Add New Retailer</div>
      <form id="addRetailerForm">
        <div class="form-group">
          <label for="retName">Name</label>
          <input type="text" id="retName" name="retName" required />
        </div>
        <div class="form-group">
          <label for="retPhone">Phone</label>
          <input type="tel" id="retPhone" name="retPhone" required pattern="[0-9]{10,15}" />
        </div>
        <div class="form-group">
          <label for="retOpeningBalance">Opening Balance</label>
          <input type="number" id="retOpeningBalance" name="retOpeningBalance" value="0" step="0.01" />
        </div>
        <div class="form-group">
          <label for="retNotes">Notes</label>
          <textarea id="retNotes" name="retNotes" rows="3"></textarea>
        </div>
        <button type="submit">Add Retailer</button>
        <button type="button" id="closeAddModal">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Edit Retailer Modal -->
  <div id="editRetailerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Edit Retailer</div>
      <form id="editRetailerForm">
        <div class="form-group">
          <label for="editRetName">Name</label>
          <input type="text" id="editRetName" name="editRetName" required />
        </div>
        <div class="form-group">
          <label for="editRetPhone">Phone</label>
          <input type="tel" id="editRetPhone" name="editRetPhone" required pattern="[0-9]{10,15}" />
        </div>
        <div class="form-group">
          <label for="editRetOpeningBalance">Opening Balance</label>
          <input type="number" id="editRetOpeningBalance" name="editRetOpeningBalance" step="0.01" />
        </div>
        <div class="form-group">
          <label for="editRetNotes">Notes</label>
          <textarea id="editRetNotes" name="editRetNotes" rows="3"></textarea>
        </div>
        <button type="submit">Update Retailer</button>
        <button type="button" id="closeEditModal">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Retailer Details Section -->
  <div id="retailerDetails">
    <h2 id="detailsName"></h2>
    <p><strong>Phone:</strong> <span id="detailsPhone"></span></p>
    <p><strong>Notes:</strong> <span id="detailsNotes"></span></p>
    <p class="total-dues">Total Pending Dues: <span id="totalDues"></span></p>

    <h3>Purchase History</h3>
    <table id="purchaseTable">
      <thead>
        <tr><th>Date</th><th>Product</th><th>Amount</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="recordPurchaseBtn">Record New Purchase</button>
    <button id="settlePaymentBtn">Settlement Payment</button>
    <button id="backToListBtn">Back to Retailer List</button>
  </div>

  <!-- Record Purchase Modal -->
  <div id="recordPurchaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Record New Purchase</div>
      <form id="recordPurchaseForm">
        <div class="form-group"><label for="purchaseDate">Date</label><input type="date" id="purchaseDate" required /></div>
        <div class="form-group"><label for="purchaseProduct">Product</label><input type="text" id="purchaseProduct" required /></div>
        <div class="form-group"><label for="purchaseAmount">Amount</label><input type="number" id="purchaseAmount" step="0.01" required /></div>
        <div class="form-group">
          <label for="purchaseStatus">Status</label>
          <select id="purchaseStatus"><option value="unpaid">Unpaid</option><option value="paid">Paid</option></select>
        </div>
        <button type="submit">Record</button>
        <button type="button" id="closeRecordModal">Cancel</button>
      </form>
    </div>
  </div>

<script>
  const API_URL = "http://127.0.0.1:5000";
  let selectedRetailerId = null;

  // Utility to format date
  function formatDate(date) {
    const d = new Date(date);
    return d.toISOString().split("T")[0];
  }

  // Show/Hide modal helpers
  function showModal(modalId) { document.getElementById(modalId).style.display = "block"; }
  function hideModal(modalId) { document.getElementById(modalId).style.display = "none"; }

  // Show "Add Retailer" modal
  document.getElementById("addRetailerBtn").addEventListener("click", () => showModal("addRetailerModal"));
  document.getElementById("closeAddModal").addEventListener("click", () => hideModal("addRetailerModal"));
  document.getElementById("closeEditModal").addEventListener("click", () => hideModal("editRetailerModal"));

  // Close modals on outside click
  window.addEventListener("click", (e) => {
    ["addRetailerModal", "editRetailerModal", "recordPurchaseModal"].forEach(id => {
      const modal = document.getElementById(id);
      if (e.target === modal) hideModal(id);
    });
  });

  // Load retailers from DB
  async function loadRetailers() {
    try {
      const res = await fetch(`${API_URL}/get_retailers`);
      const retailers = await res.json();
      renderRetailerTable(retailers);
    } catch (err) { console.error("Error loading retailers:", err); }
  }

  // Render retailers table with View/Edit/Delete buttons
  function renderRetailerTable(retailers) {
    const tbody = document.querySelector("#retailerTable tbody");
    tbody.innerHTML = "";
    retailers.forEach(ret => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ret.name}</td>
        <td>${ret.phone}</td>
        <td>${ret.total_due || 0}</td>
        <td>${ret.last_payment_date || "-"}</td>
        <td class="actions">
          <button onclick="viewRetailerDetails(${ret.id})">View</button>
        </td>
      `;
      tbody.appendChild(tr);  
    });
  }

  // View retailer details
  async function viewRetailerDetails(id) {
    selectedRetailerId = id;
    try {
      const res = await fetch(`${API_URL}/get_retailers`)
      const purchases = await res.json();

      const detailsRes = await fetch(`${API_URL}/add_retailer`) 
      const retailers = await detailsRes.json();
      const retailer = retailers.find(r => r.id === id);

      document.getElementById("detailsName").textContent = retailer.name;
      document.getElementById("detailsPhone").textContent = retailer.phone;
      document.getElementById("detailsNotes").textContent = retailer.notes || "-";

      renderPurchaseHistory(purchases);
      document.getElementById("totalDues").textContent = "$" + (retailer.total_due || 0);

      document.getElementById("retailerDetails").style.display = "block";
      document.getElementById("retailerTable").style.display = "table";
      document.getElementById("addRetailerBtn").style.display = "inline-block";
    } catch (err) { console.error("Error fetching retailer details:", err); }
  }

  function renderPurchaseHistory(purchases) {
    const tbody = document.querySelector("#purchaseTable tbody");
    tbody.innerHTML = "";
    purchases.forEach(p => {
      const statusClass = p.status === "paid" ? "paid" : "unpaid";
      const statusText = p.status.charAt(0).toUpperCase() + p.status.slice(1);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.date}</td>
        <td>${p.product}</td>
        <td>$${parseFloat(p.amount).toFixed(2)}</td>
        <td class="${statusClass}">${statusText}</td>
      `;
      tbody.appendChild(tr);
    });
  }


  // Add retailer
  document.getElementById("addRetailerForm").addEventListener("submit", async e => {
    e.preventDefault();
    const name = e.target.retName.value.trim();
    const phone = e.target.retPhone.value.trim();
    const openingBalance = parseFloat(e.target.retOpeningBalance.value) || 0;
    const notes = e.target.retNotes.value.trim();

    try {
      const res = await fetch(`${API_URL}/add_retailer`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone, notes, openingBalance })
      });

      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      const result = await res.json();
      alert(result.message);

      // ✅ Put these two lines here, after success
      hideModal("addRetailerModal");
      document.getElementById("addRetailerForm").reset();

      loadRetailers(); // refresh the table
    } catch (err) {
      console.error("Error adding retailer:", err);
      alert("Failed to add retailer. See console for details.");
    }
  });
  // Back button
  document.getElementById("backToListBtn").addEventListener("click", () => {
    selectedRetailerId = null;
    document.getElementById("retailerDetails").style.display = "none";
    document.getElementById("retailerTable").style.display = "table";
    document.getElementById("addRetailerBtn").style.display = "inline-block";
  });

  // Initial load
  loadRetailers();
</script>

</body>
</html>
